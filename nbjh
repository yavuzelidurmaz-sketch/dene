import requests

import json

import time

import os



# --- AYARLAR ---

PROJECT_ID = "2da7kf8jf"

ADULT_PROFILE_ID = "URCMQDLDLXJLHLPFBAN0ZI9V"

KIDS_PROFILE_ID = "KIBPFC0Q9Z08Q1UMMJTO61NI"



# GiriÅŸ Bilgilerini GitHub Secrets'tan AlÄ±r

GAIN_EMAIL = os.environ.get("GAIN_EMAIL")

GAIN_PASSWORD = os.environ.get("GAIN_PASSWORD")



# API URL'leri

BASE_URL = f"https://api.gain.tv/{PROJECT_ID}/CALL"

LOGIN_URL = f"{BASE_URL}/Member/login"



HEADERS = {

    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",

    "Content-Type": "application/json",

    "x-gain-platform": "web",

    "Origin": "https://www.gain.tv",

    "Referer": "https://www.gain.tv/"

}



# Hedefler

TARGETS = [

    {"name": "Film", "profile_id": ADULT_PROFILE_ID, "param": "slug=%2Ffilm"},

    {"name": "Dizi", "profile_id": ADULT_PROFILE_ID, "param": "slug=%2Fdizi"},

    {"name": "Program", "profile_id": ADULT_PROFILE_ID, "param": "slug=%2Fprogram"},

    {"name": "Kids", "profile_id": KIDS_PROFILE_ID, "param": "categoryName=MAIN-PAGE"}

]



def auto_login():

    """KullanÄ±cÄ± adÄ± ve ÅŸifre ile Token Ã¼retir"""

    print("\nğŸ” Gain.tv'ye otomatik giriÅŸ yapÄ±lÄ±yor...")

    

    if not GAIN_EMAIL or not GAIN_PASSWORD:

        print("â›” HATA: E-posta veya Åifre bulunamadÄ±! GitHub Secrets ayarlarÄ±nÄ± kontrol et.")

        return None



    payload = {

        "username": GAIN_EMAIL,

        "password": GAIN_PASSWORD,

        "keepMeSignedIn": True

    }



    try:

        response = requests.post(LOGIN_URL, headers=HEADERS, json=payload)

        data = response.json()

        

        if response.status_code == 200 and data.get("Success"):

            token = data.get("Result", {}).get("Token")

            print("âœ… GiriÅŸ BaÅŸarÄ±lÄ±! Taze Token alÄ±ndÄ±.")

            return token

        else:

            print(f"âŒ GiriÅŸ BaÅŸarÄ±sÄ±z: {data.get('Message')}")

            return None

    except Exception as e:

        print(f"ğŸ”¥ BaÄŸlantÄ± HatasÄ±: {e}")

        return None



def get_token_headers(token):

    auth_headers = HEADERS.copy()

    auth_headers["Authorization"] = f"Bearer {token}"

    return auth_headers



def get_episodes(title_id, season_id, profile_id, auth_headers):

    url = f"{BASE_URL}/ProfileTitle/getProfileSeason/{profile_id}?seasonId={season_id}&titleId={title_id}&__culture=tr-tr&pageSize=500"

    try:

        res = requests.get(url, headers=auth_headers)

        if res.status_code == 200:

            return res.json().get("episodes", [])

    except:

        pass

    return []



def get_contents(target, token):

    url = f"{BASE_URL}/ProfileTitle/getPlaylistsByCategory/{target['profile_id']}?{target['param']}&__culture=tr-tr&pageSize=500"

    print(f"\nğŸŒ '{target['name']}' bÃ¶lÃ¼mÃ¼ taranÄ±yor...")

    

    auth_headers = get_token_headers(token)

    contents = []

    processed_ids = set()

    

    try:

        res = requests.get(url, headers=auth_headers)

        if res.status_code != 200:

            print(f"   âŒ EriÅŸim HatasÄ±: {res.status_code}")

            return []

            

        playlists = res.json().get("playlists", [])

        print(f"   ğŸ“¦ {len(playlists)} raf bulundu. Analiz ediliyor...")



        for playlist in playlists:

            shelf_name = playlist.get("title", "Genel")

            items = playlist.get("items", [])

            

            for item in items:

                title_id = item.get("titleId")

                video_id = item.get("videoContentId")

                name = item.get("name") or item.get("title")

                poster = item.get("logoImageUrl") or item.get("posterImageUrl")

                seasons = item.get("seasons", [])



                if title_id in processed_ids: continue

                processed_ids.add(title_id)



                if seasons: # Dizi/Program

                    for season in seasons:

                        episodes = get_episodes(title_id, season.get("id"), target['profile_id'], auth_headers)

                        for ep in episodes:

                            full_title = f"{ep.get('episode', 0)}. BÃ¶lÃ¼m - {ep.get('name', '')}"

                            prefix = "Kids" if target['name'] == "Kids" else target['name']

                            group_name = f"Gain - {prefix} | {name}"



                            contents.append({

                                "id": ep.get("videoContentId"),

                                "title": full_title,

                                "group": group_name,

                                "poster": poster,

                                "profile_id": target['profile_id']

                            })



                elif video_id: # Film

                    if target['name'] == "Kids":

                        group_name = f"Gain - Kids | {shelf_name}"

                    elif target['name'] == "Film":

                        group_name = f"Gain - Film | {shelf_name}"

                    else:

                        group_name = f"Gain - {target['name']} | {shelf_name}"



                    contents.append({

                        "id": video_id,

                        "title": name,

                        "group": group_name,

                        "poster": poster,

                        "profile_id": target['profile_id']

                    })

                            

        print(f"   âœ… '{target['name']}' kategorisinden {len(contents)} video eklendi.")

        return contents



    except Exception as e:

        print(f"ğŸ”¥ Hata: {e}")

        return []



def get_stream_url(content, token):

    url = f"{BASE_URL}/ProfileTitle/getPlaybackInfo/{content['profile_id']}/"

    params = {"videoContentId": content["id"], "packageType": "Dash", "__culture": "tr-tr"}

    auth_headers = get_token_headers(token)

    

    try:

        res = requests.get(url, headers=auth_headers, params=params)

        if res.status_code == 200:

            pb_url = res.json().get("currentVideoContent", {}).get("playbackUrl")

            if pb_url:

                content["stream_url"] = pb_url

                return content

    except:

        pass

    return None



def save_m3u(data, filename="fanatik_gain.m3u"):

    print(f"\nğŸ“º M3U dosyasÄ± oluÅŸturuluyor: {filename}...")

    data.sort(key=lambda x: x["group"])

    with open(filename, "w", encoding="utf-8") as f:

        f.write("#EXTM3U\n")

        for item in data:

            f.write(f'#EXTINF:-1 group-title="{item["group"]}" tvg-logo="{item["poster"]}", {item["title"]}\n')

            f.write('#EXTVLCOPT:http-user-agent=Mozilla/5.0\n')

            f.write(f"{item['stream_url']}\n")

    print("âœ… M3U HazÄ±r!")



def main():

    # 1. ADIM: Otomatik Token Al

    token = auto_login()

    if not token:

        return # GiriÅŸ yapamazsa dur



    all_videos = []

    

    # 2. ADIM: Ä°Ã§erikleri Tara

    for target in TARGETS:

        items = get_contents(target, token)

        all_videos.extend(items)

        time.sleep(1)



    total = len(all_videos)

    if total == 0:

        print("\nâ›” LÄ°STE BOÅ GELDÄ°!")

        return



    print(f"\nğŸš€ TOPLAM {total} Ä°Ã‡ERÄ°K Ä°Ã‡Ä°N LÄ°NKLER Ã‡EKÄ°LÄ°YOR...")

    

    final_list = []

    for i, video in enumerate(all_videos):

        full_data = get_stream_url(video, token)

        if full_data:

            del full_data["profile_id"]

            final_list.append(full_data)

        

        if (i+1) % 25 == 0: 

            print(f"   ğŸ‘ {i+1}/{total} tamamlandÄ±... ({len(final_list)} baÅŸarÄ±lÄ±)")

        time.sleep(0.01)



    with open("gain_full_archive.json", "w", encoding="utf-8") as f:

        json.dump(final_list, f, indent=4, ensure_ascii=False)

    

    save_m3u(final_list)

    print("\nğŸ OPERASYON BAÅARIYLA TAMAMLANDI!")



if __name__ == "__main__":

    main()   name: Gain Auto Scraper



on:

  workflow_dispatch: # Manuel tetikleme butonu

  schedule:

    - cron: '0 0 * * *' # Her gece 00:00'da Ã§alÄ±ÅŸÄ±r



permissions:

  contents: write



jobs:

  scrape:

    runs-on: ubuntu-latest



    steps:

    - name: Depoyu Ã‡ek (Checkout)

      uses: actions/checkout@v3



    - name: Python Kur

      uses: actions/setup-python@v4

      with:

        python-version: '3.9'



    - name: KÃ¼tÃ¼phaneleri YÃ¼kle

      run: pip install requests



    - name: Botu Ã‡alÄ±ÅŸtÄ±r (Otomatik GiriÅŸli)

      env: 

        # Ä°ÅŸte burasÄ± senin ÅŸifrelerini gÃ¼venle koda aktarÄ±r

        GAIN_EMAIL: ${{ secrets.GAIN_EMAIL }}

        GAIN_PASSWORD: ${{ secrets.GAIN_PASSWORD }}

      run: python main.py



    - name: Verileri Kaydet (Commit & Push)

      run: |

        git config --global user.name "GainBot"

        git config --global user.email "bot@github.com"

        

        # DosyalarÄ± ekle (Varsa)

        if [ -f gain_full_archive.json ]; then

          git add gain_full_archive.json

        fi

        

        if [ -f fanatik_gain.m3u ]; then

          git add fanatik_gain.m3u

        fi



        # DeÄŸiÅŸiklik varsa gÃ¶nder

        git commit -m "Otomatik GÃ¼ncelleme: $(date)" || echo "DeÄŸiÅŸiklik yok"

        git push
